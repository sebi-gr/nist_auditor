name: PR Security
on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

jobs:
  provenance:
    name: 1) Provenance Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Validate PR body has provenance trailer
        run: |
          body="${{ github.event.pull_request.body || '' }}"
          echo "$body" | grep -Eiq '^\s*\*{0,2}Provenance\*{0,2}\s*:\s*(ai|human|external|mixed|unknown)\s*$' || {
            echo "Missing or invalid 'Provenance:' trailer in PR body." >&2
            exit 1
          }

  secrets:
    name: 2) Secrets (Gitleaks)
    runs-on: ubuntu-latest
    needs: provenance            # <-- runs only after provenance succeeds
    permissions:
      contents: read
      pull-requests: read
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Run Gitleaks on PR range
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          args: >
            detect --redact --no-banner --exit-code 1
            --log-opts "${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }}"

  semgrep:
    name: 3) Semgrep (Java)
    runs-on: ubuntu-latest
    needs: secrets               # <-- runs after secrets
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Semgrep security-audit
        uses: returntocorp/semgrep-action@v1
        with:
          config: p/security-audit
          generateSarif: true
          sarifFile: semgrep.sarif
      - uses: actions/upload-artifact@v4
        with:
          name: semgrep-sarif
          path: semgrep.sarif

  # Optional: keep CodeQL as a "deep lane" in the same ordered chain (slower)
  codeql:
    name: 4) CodeQL (Java - manual build)
    runs-on: ubuntu-latest
    needs: semgrep               # <-- runs after semgrep
    permissions:
      security-events: write
      contents: read
      actions: read
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: actions/setup-java@v4
        with: { distribution: temurin, java-version: "21" }
      - uses: github/codeql-action/init@v3
        with: { languages: java }
      - name: Manual build (javac)
        run: |
          mkdir -p build
          javac -g -d build $(git ls-files "*.java")
      - uses: github/codeql-action/analyze@v3
        with:
          category: "/language:java"
