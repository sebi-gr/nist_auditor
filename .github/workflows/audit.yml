name: PR Security
on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

# Ensure only the latest run per PR is active
concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  provenance:
    name: 1) Provenance Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read

    outputs:
      provenance: ${{ steps.match.outputs.group1 }}

    steps:
      - name: Validate PR body has provenance trailer
        uses: actions-ecosystem/action-regex-match@v2
        id: match
        with:
          text: "${{ github.event.pull_request.body || '' }}"
          regex: 'Provenance:\s*(ai|human|external|mixed|unknown)\s*'
          flags: 'mi'

      - name: Fail if Provenance missing/invalid
        if: steps.match.outputs.match == ''
        run: |
          echo "Missing or invalid 'Provenance:' trailer in PR body." >&2
          exit 1

      - name: Validate Security-Gate-Mode
        uses: actions-ecosystem/action-regex-match@v2
        id: qg_mode
        with:
          text: "${{ github.event.pull_request.body || '' }}"
          regex: 'Security-Gate-Mode:\s*(enforce|warn|none)\s*'
          flags: 'mi'

      - name: Fail if Security-Gate-Mode missing/invalid
        if: steps.qg_mode.outputs.match == ''
        run: |
          echo "Missing or invalid 'Security-Gate-Mode' in PR body." >&2
          exit 1

      - name: Validate MaxTotalIssueGroups
        uses: actions-ecosystem/action-regex-match@v2
        id: qg_total
        with:
          text: "${{ github.event.pull_request.body || '' }}"
          regex: 'MaxTotalIssueGroups:\s*[0-9]+\s*'
          flags: 'mi'

      - name: Fail if MaxTotalIssueGroups missing/invalid
        if: steps.qg_total.outputs.match == ''
        run: |
          echo "Missing or invalid 'MaxTotalIssueGroups' in PR body." >&2
          exit 1

      - name: Validate MaxHighSeverityFindings
        uses: actions-ecosystem/action-regex-match@v2
        id: qg_high
        with:
          text: "${{ github.event.pull_request.body || '' }}"
          regex: 'MaxHighSeverityFindings:\s*[0-9]+\s*'
          flags: 'mi'

      - name: Fail if MaxHighSeverityFindings missing/invalid
        if: steps.qg_high.outputs.match == ''
        run: |
          echo "Missing or invalid 'MaxHighSeverityFindings' in PR body." >&2
          exit 1

      - name: Validate MaxDensityPerKLoCGrouped
        uses: actions-ecosystem/action-regex-match@v2
        id: qg_density
        with:
          text: "${{ github.event.pull_request.body || '' }}"
          regex: 'MaxDensityPerKLoCGrouped:\s*[0-9]*\.?[0-9]+\s*'
          flags: 'mi'

      - name: Fail if MaxDensityPerKLoCGrouped missing/invalid
        if: steps.qg_density.outputs.match == ''
        run: |
          echo "Missing or invalid 'MaxDensityPerKLoCGrouped' in PR body." >&2
          exit 1

      - name: Validate MaxSecretFindings
        uses: actions-ecosystem/action-regex-match@v2
        id: qg_secret
        with:
          text: "${{ github.event.pull_request.body || '' }}"
          regex: 'MaxSecretFindings:\s*[0-9]+\s*'
          flags: 'mi'

      - name: Fail if MaxSecretFindings missing/invalid
        if: steps.qg_secret.outputs.match == ''
        run: |
          echo "Missing or invalid 'MaxSecretFindings' in PR body." >&2
          exit 1

  gitleaks:
    name: 2) Secrets Scan (Gitleaks)
    runs-on: ubuntu-latest
    needs: provenance
    permissions:
      contents: read
      pull-requests: read
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Run Gitleaks on PR range
        continue-on-error: true
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ github.token }}   # required by the action
          GITLEAKS_ENABLE_UPLOAD_ARTIFACT: "false"
        with:
          args: >
            detect --source=. --no-git --redact --no-banner --exit-code 1

      - name: Normalize Gitleaks SARIF path
        if: ${{ always() }}
        run: |
          if [ -f results.sarif ]; then
            mv results.sarif gitleaks.sarif
          fi
          if [ ! -f gitleaks.sarif ]; then
            echo '{"version":"2.1.0","runs":[]}' > gitleaks.sarif
          fi

      - name: Upload Gitleaks SARIF
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-sarif
          path: gitleaks.sarif

  semgrep:
    name: 3) Semgrep (Java)
    runs-on: ubuntu-latest
    needs: gitleaks
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Run Semgrep (security-audit)
        continue-on-error: true
        uses: returntocorp/semgrep-action@v1
        with:
          config: p/security-audit
          generateSarif: "1"

      - name: Ensure Semgrep SARIF exists
        if: ${{ always() }}
        run: |
          if [ ! -f semgrep.sarif ]; then
            echo '{"version":"2.1.0","runs":[]}' > semgrep.sarif
          fi

      - name: Upload Semgrep SARIF
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-sarif
          path: semgrep.sarif

  codeql:
    name: 4) CodeQL (Java - manual build)
    runs-on: ubuntu-latest
    needs: semgrep
    permissions:
      security-events: write
      contents: read
      actions: read
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java

      - name: Build Java
        run: |
          mkdir -p build
          javac -cp "lib/javax.servlet-api-4.0.1.jar" -g -d build $(git ls-files "*.java")

      - name: Analyze
        continue-on-error: true
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:java"
          output: codeql-results

      - name: Ensure CodeQL SARIF exists
        if: ${{ always() }}
        run: |
          mkdir -p codeql-results
          if ! ls codeql-results/*.sarif >/dev/null 2>&1; then
            echo '{"version":"2.1.0","runs":[]}' > codeql-results/java.sarif
          fi

      - name: Upload CodeQL SARIF
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: codeql-sarif
          path: codeql-results

  metrics:
    name: 5) Security Metrics
    runs-on: ubuntu-latest
    needs: [gitleaks, semgrep, codeql]
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download SARIF artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*-sarif'
          path: sarif

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Run SARIF aggregation
        run: |
          python .github/workflows/scripts/aggregate_sarif.py --sarif-dir sarif --repo-root .

      - name: Upload metrics JSON
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: security-metrics
          path: security-metrics.json

  quality_gate:
    name: 6) Security Quality Gate + RMF Report
    runs-on: ubuntu-latest
    needs: [metrics, provenance]
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download security metrics
        uses: actions/download-artifact@v4
        with:
          name: security-metrics
          path: .

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install report deps
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Run Security Quality Gate
        id: enforce
        env:
          PR_BODY: ${{ github.event.pull_request.body || '' }}
        run: |
          python .github/workflows/scripts/enforce_quality_gate.py --metrics-file security-metrics.json

      # --- ab hier: Report läuft IMMER, auch wenn Quality Gate failt ---
      - name: Prepare report inputs
        if: ${{ always() }}
        run: |
          mkdir -p artifacts
          cp security-metrics.json artifacts/summary.json

      - name: Build RMF report
        if: ${{ always() }}
        env:
          PROVENANCE: ${{ needs.provenance.outputs.provenance || 'unknown' }}
          SCAN_SCOPE: diff-only
          REPO_NAME: ${{ github.repository }}
          COMMIT_SHA: ${{ github.sha }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          # Gate-Status für den Report (aus Ergebnis des enforce Steps)
          GATE_STATUS: ${{ steps.enforce.outcome == 'failure' && 'fail' || 'pass' }}
        run: |
          python tools/report_step.py

      - name: Upload RMF report artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: rmf-report
          path: |
            artifacts/report.json
            artifacts/report.html
            artifacts/pr_summary.md
