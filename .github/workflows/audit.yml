name: PR Security
on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

# Ensure only the latest run per PR is active
concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  provenance:
    name: 1) Provenance Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Validate PR body has provenance trailer
        run: |
          body="${{ github.event.pull_request.body }}"
          # Matches bold (**Provenance:** ai) or plain (Provenance: ai)
          if ! printf '%s\n' "$body" | grep -Eiq '^\s*\*{0,2}Provenance\*{0,2}\s*:\s*(ai|human|external|mixed|unknown)\s*$'; then
            echo "Missing or invalid 'Provenance:' trailer in PR body." >&2
            exit 1
          fi

  gitleaks:
    name: 2) Secrets Scan (Gitleaks)
    runs-on: ubuntu-latest
    needs: provenance
    permissions:
      contents: read
      pull-requests: read
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Run Gitleaks on PR range
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ github.token }}   # required by the action
        with:
          args: >
            detect --redact --no-banner --exit-code 1
            --log-opts "${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }}"

  semgrep:
    name: 3) Semgrep (Java)
    runs-on: ubuntu-latest
    needs: gitleaks
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Run Semgrep (security-audit)
        uses: returntocorp/semgrep-action@v1
        with:
          config: p/security-audit
          generateSarif: true
          sarifFile: semgrep.sarif
      - name: Upload SARIF
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-sarif
          path: semgrep.sarif

  codeql:
    name: 4) CodeQL (Java - manual build)
    runs-on: ubuntu-latest
    needs: semgrep
    permissions:
      security-events: write
      contents: read
      actions: read
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java
      - name: Manual build (javac)
        run: |
          mkdir -p build
          javac -g -d build $(git ls-files "*.java")
      - name: Analyze
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:java"
